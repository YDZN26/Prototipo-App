<ion-header [translucent]="true">
  <ion-toolbar style="--background: #001E87; --color: white;">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ esEdicion ? 'Editar Producto' : 'Crear Producto' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="crear-producto-content">
  <div class="form-container">
    <!-- Imagen del producto -->
    <div class="imagen-container">
      <div class="imagen-preview" *ngIf="producto.imagenUrl">
        <img [src]="producto.imagenUrl" alt="Imagen del producto">
        <ion-button
          fill="clear"
          class="remove-image-btn"
          (click)="eliminarImagen()">
          <ion-icon name="close-circle"></ion-icon>
        </ion-button>
      </div>

      <div class="imagen-placeholder" *ngIf="!producto.imagenUrl" (click)="mostrarOpcionesImagen()">
        <ion-icon name="camera-outline" size="large"></ion-icon>
        <span>Imagen Producto</span>
      </div>
    </div>

    <!-- Formulario -->
    <div class="form-section">
      <!-- Nombre del producto -->
      <div class="input-group">
        <ion-label class="input-label">Nombre Producto</ion-label>
        <ion-input
          type="text"
          placeholder="Ingrese el nombre del Producto"
          [(ngModel)]="producto.nombre"
          class="custom-input">
        </ion-input>
      </div>

      <!-- Cantidad - NO NEGATIVOS -->
      <div class="input-group">
        <ion-label class="input-label">Cantidad</ion-label>
        <ion-input
          type="number"
          min="0"
          placeholder="Ingrese la cantidad"
          [(ngModel)]="producto.cantidad"
          (ionInput)="validarNumeroPositivo($event, 'cantidad')"
          class="custom-input">
        </ion-input>
      </div>

      <!-- Precio Unitario - NO NEGATIVOS -->
      <div class="input-group">
        <ion-label class="input-label">Precio Unitario</ion-label>
        <ion-input
          type="number"
          min="0"
          step="0.01"
          placeholder="Ingrese el precio unitario"
          [(ngModel)]="producto.precioUnitario"
          (ionInput)="validarNumeroPositivo($event, 'precioUnitario')"
          class="custom-input">
        </ion-input>
      </div>

      <!-- Costo Unitario - NO NEGATIVOS -->
      <div class="input-group">
        <ion-label class="input-label">Costo Unitario</ion-label>
        <ion-input
          type="number"
          min="0"
          step="0.01"
          placeholder="Ingrese el costo unitario"
          [(ngModel)]="producto.costoUnitario"
          (ionInput)="validarNumeroPositivo($event, 'costoUnitario')"
          class="custom-input">
        </ion-input>
      </div>

      <!-- Categoría -->
      <div class="input-group">
        <ion-label class="input-label">Categoría</ion-label>
        <ion-button
          expand="block"
          fill="outline"
          class="select-categoria-button"
          [class.categoria-selected]="categoriaSeleccionadaNombre"
          (click)="abrirModalCategorias()">
          <ion-icon name="pricetag-outline" slot="start"></ion-icon>
          <span class="categoria-seleccionada">{{ categoriaSeleccionadaNombre || 'Seleccione la categoría' }}</span>
          <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Botón guardar -->
    <div class="guardar-container">
      <ion-button
        expand="block"
        class="guardar-button"
        (click)="guardarProducto()"
        [disabled]="loading">
        <ion-spinner name="crescent" *ngIf="loading"></ion-spinner>
        {{ loading ? 'Guardando...' : (esEdicion ? 'Actualizar Producto' : 'Guardar Producto') }}
      </ion-button>
    </div>
  </div>

  <!-- Input oculto para subir archivo -->
  <input
    #fileInput
    type="file"
    accept="image/*"
    style="display: none"
    (change)="onFileSelected($event)">
</ion-content>

<!-- Modal para opciones de imagen -->
<ion-modal #modalOpcionesImagen [isOpen]="modalImagenAbierto" (didDismiss)="cerrarModalImagen()">
  <ng-template>
    <ion-header>
      <ion-toolbar style="--background: #001E87; --color: white;">
        <ion-title>Agregar Imagen</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalImagen()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-opciones-imagen">
      <div class="opciones-container">
        <!-- Opción 1: Subir desde dispositivo -->
        <ion-button
          expand="block"
          fill="outline"
          class="opcion-button"
          (click)="abrirGaleria()">
          <ion-icon name="images-outline" slot="start"></ion-icon>
          Subir desde Dispositivo
        </ion-button>

        <!-- Opción 2: Pegar URL -->
        <ion-button
          expand="block"
          fill="outline"
          class="opcion-button"
          (click)="mostrarFormularioURL()">
          <ion-icon name="link-outline" slot="start"></ion-icon>
          Pegar URL de Imagen
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para pegar URL -->
<ion-modal #modalURL [isOpen]="modalURLAbierto" (didDismiss)="cerrarModalURL()">
  <ng-template>
    <ion-header>
      <ion-toolbar style="--background: #001E87; --color: white;">
        <ion-buttons slot="start">
          <ion-button (click)="cerrarModalURL()">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>URL de Imagen</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="modal-url-content">
      <div class="url-container">
        <!-- Input para URL -->
        <div class="input-group">
          <ion-label class="input-label">URL de la Imagen</ion-label>
          <ion-input
            type="url"
            placeholder="https://ejemplo.com/imagen.jpg"
            [(ngModel)]="urlTemporal"
            class="custom-input">
          </ion-input>
        </div>

        <!-- Vista previa -->
        <div class="preview-container" *ngIf="urlTemporal">
          <ion-label class="input-label">Vista Previa:</ion-label>
          <div class="preview-image">
            <img
              [src]="urlTemporal"
              alt="Vista previa"
              (error)="onImageError()"
              (load)="onImageLoad()">
            <div class="preview-loading" *ngIf="!imagenCargada && !imagenError">
              <ion-spinner name="crescent"></ion-spinner>
            </div>
            <div class="preview-error" *ngIf="imagenError">
              <ion-icon name="alert-circle-outline"></ion-icon>
              <p>No se pudo cargar la imagen</p>
            </div>
          </div>
        </div>

        <!-- Botón guardar -->
        <ion-button
          expand="block"
          class="guardar-url-button"
          (click)="guardarURL()"
          [disabled]="!urlTemporal || imagenError">
          Guardar URL
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de Categorías -->
<ion-modal #modalCategorias [isOpen]="modalCategoriasAbierto" (didDismiss)="cerrarModalCategorias()">
  <ng-template>
    <ion-header>
      <ion-toolbar style="--background: #001E87; --color: white;">
        <ion-title>Seleccionar Categoría</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalCategorias()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <!-- Lista de categorías -->
      <ion-list>
        <ion-item
          *ngFor="let categoria of categorias"
          button
          (click)="seleccionarCategoria(categoria)"
          [class.selected-item]="producto.categoria === categoria.id">
          <ion-icon name="pricetag" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h2>{{ categoria.nombre }}</h2>
          </ion-label>
          <ion-icon
            *ngIf="producto.categoria === categoria.id"
            name="checkmark-circle"
            slot="end"
            color="primary">
          </ion-icon>
        </ion-item>

        <!-- Mensaje cuando no hay categorías -->
        <div *ngIf="categorias.length === 0" class="no-categorias">
          <ion-icon name="pricetag-outline" size="large"></ion-icon>
          <p>No hay categorías disponibles</p>
        </div>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>