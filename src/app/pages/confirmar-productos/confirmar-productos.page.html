<ion-header [translucent]="true">
  <ion-toolbar style="--background: #001E87; --color: white;">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Confirmar Precios y Cantidades</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="confirmar-productos-content">
  <!-- Lista de productos seleccionados -->
  <div class="productos-carrito">
    <div
      *ngFor="let producto of productosCarrito; let i = index"
      class="producto-carrito-item">

      <!-- Nombre del producto -->
      <div class="producto-header">
        <h3 class="producto-nombre">{{ producto.nombre }}</h3>
        <ion-button
          fill="clear"
          class="eliminar-button"
          (click)="eliminarProducto(i)">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
      </div>

      <div class="producto-controls">
        <!-- Control de cantidad - EDITABLE CON VALIDACIÓN MEJORADA -->
<div class="cantidad-control">
  <ion-label class="control-label">Cantidad*</ion-label>
  <div class="cantidad-buttons">
    <ion-button
      fill="clear"
      class="cantidad-btn"
      (click)="decrementarCantidad(i)"
      [disabled]="producto.cantidad <= 1">
      <ion-icon name="remove-outline"></ion-icon>
    </ion-button>
    
    <!-- Input editable para cantidad -->
    <ion-input
      type="number"
      min="1"
      [max]="producto.stock"
      [(ngModel)]="producto.cantidadTexto"
      (ionInput)="onCantidadInput(i, $event)"
      (ionBlur)="validarCantidadAlSalir(i)"
      (ionFocus)="onCantidadFocus(i)"
      class="cantidad-input"
      [class.cantidad-invalida]="producto.cantidadInvalida">
    </ion-input>
    
    <ion-button
      fill="clear"
      class="cantidad-btn"
      (click)="incrementarCantidad(i)"
      [disabled]="producto.cantidad >= producto.stock">
      <ion-icon name="add-outline"></ion-icon>
    </ion-button>
  </div>
  
  <!-- Mensaje de error -->
  <div class="cantidad-error" *ngIf="producto.cantidadInvalida">
    La cantidad debe ser mayor a 0
  </div>
</div>

        <!-- Precio unitario - NO NEGATIVO -->
        <div class="precio-control">
          <ion-label class="control-label">Precio Unitario*</ion-label>
          <div class="precio-input-wrapper">
            <ion-input
              type="number"
              min="0"
              step="0.01"
              [(ngModel)]="producto.precioUnitario"
              (ionInput)="validarPrecio(i, $event)"
              class="precio-input">
            </ion-input>
            <span class="precio-suffix">Bs.</span>
          </div>
        </div>
      </div>

      <!-- Cantidad restante -->
      <div class="cantidad-restante">
        <span>Cantidad restante: {{ producto.stock - producto.cantidad }}</span>
      </div>
    </div>
  </div>

  <!-- Concepto de la venta -->
  <div class="concepto-container">
    <ion-label class="concepto-label">Concepto:</ion-label>
    <div class="concepto-texto">{{ conceptoVenta }}</div>
  </div>

  <!-- Total a pagar -->
  <div class="total-container">
    <div class="total-label">Total a Pagar:</div>
    <div class="total-amount">{{ calcularTotal() }} Bs.</div>
  </div>

  <!-- Botones de acción -->
  <div class="acciones-container">
    <ion-button
      expand="block"
      fill="outline"
      class="agregar-mas-button"
      (click)="agregarMasProductos()">
      <ion-icon name="add-circle-outline" slot="start"></ion-icon>
      Agregar Más Productos
    </ion-button>

    <ion-button
      expand="block"
      class="confirmar-button"
      (click)="confirmarVenta()"
      [disabled]="productosCarrito.length === 0 || loading">
      <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
      <span *ngIf="!loading">Confirmar Venta</span>
    </ion-button>
  </div>
</ion-content>