<ion-header [translucent]="true">
  <ion-toolbar style="--background: #001E87; --color: white;">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="volver()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Nueva Venta</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="nueva-venta-content">
  <div class="form-container">
    <!-- Cliente -->
    <div class="input-group">
      <ion-label class="input-label">Cliente:</ion-label>
      <ion-button
        expand="block"
        fill="outline"
        class="select-cliente-button"
        (click)="abrirModalClientes()">
        <ion-icon name="person-outline" slot="start"></ion-icon>
        <span class="cliente-seleccionado">{{ clienteSeleccionadoNombre || 'Selecciona un cliente' }}</span>
        <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
      </ion-button>
    </div>

    <!-- Método de Pago -->
    <div class="input-group">
      <ion-label class="input-label">Método de Pago:</ion-label>
      <div class="payment-methods">
        <ion-button
          *ngFor="let metodo of metodosPago"
          class="payment-button"
          [fill]="venta.metodoPago === metodo.id ? 'solid' : 'outline'"
          (click)="seleccionarMetodoPago(metodo.id)">
          <ion-icon [name]="metodo.icono"></ion-icon>
          {{ metodo.nombre }}
        </ion-button>
      </div>
    </div>

    <!-- Botón Continuar -->
    <div class="continuar-container">
      <ion-button
        expand="block"
        class="continuar-button"
        (click)="continuarASeleccion()"
        [disabled]="!puedesContinuar()">
        Continuar a Selección de Productos
      </ion-button>
    </div>
  </div>
</ion-content>

<!-- Modal de Clientes -->
<ion-modal #modalClientes [isOpen]="modalClientesAbierto" (didDismiss)="cerrarModalClientes()">
  <ng-template>
    <ion-header>
      <ion-toolbar style="--background: #001E87; --color: white;">
        <ion-title>Seleccionar Cliente</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalClientes()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>

      <!-- Barra de búsqueda -->
      <ion-toolbar color="light">
        <ion-searchbar
          [(ngModel)]="busquedaCliente"
          (ionInput)="filtrarClientes()"
          placeholder="Buscar por nombre, teléfono..."
          debounce="300">
        </ion-searchbar>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <!-- Botón crear nuevo cliente -->
      <div class="crear-cliente-container">
        <ion-button
          expand="block"
          fill="outline"
          color="primary"
          (click)="abrirFormularioNuevoCliente()">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Crear Nuevo Cliente
        </ion-button>
      </div>

      <!-- Lista de clientes filtrados -->
      <ion-list>
        <ion-item
          *ngFor="let cliente of clientesFiltrados"
          button
          (click)="seleccionarCliente(cliente)"
          [class.selected-item]="venta.clienteId === cliente.id.toString()">
          <ion-icon name="person-circle-outline" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h2>{{ cliente.nombre }}</h2>
            <p *ngIf="cliente.telefono">{{ cliente.telefono }}</p>
          </ion-label>
          <ion-icon
            *ngIf="venta.clienteId === cliente.id.toString()"
            name="checkmark-circle"
            slot="end"
            color="primary">
          </ion-icon>
        </ion-item>

        <!-- Mensaje cuando no hay resultados -->
        <div *ngIf="clientesFiltrados.length === 0" class="no-resultados">
          <ion-icon name="search-outline" size="large"></ion-icon>
          <p>No se encontraron clientes</p>
          <ion-button fill="outline" (click)="abrirFormularioNuevoCliente()">
            Crear Cliente
          </ion-button>
        </div>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal para crear nuevo cliente -->
<ion-modal #modalNuevoCliente [isOpen]="modalNuevoClienteAbierto" (didDismiss)="cerrarModalNuevoCliente()">
  <ng-template>
    <ion-header>
      <ion-toolbar style="--background: #001E87; --color: white;">
        <ion-buttons slot="start">
          <ion-button (click)="cerrarModalNuevoCliente()">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Nuevo Cliente</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="form-nuevo-cliente">
      <div class="form-container-modal">
        <!-- Nombre -->
        <div class="input-group">
          <ion-label class="input-label">Nombre *</ion-label>
          <ion-input
            [(ngModel)]="nuevoCliente.nombre"
            placeholder="Ingresa el nombre"
            class="custom-input">
          </ion-input>
        </div>

        <!-- Teléfono -->
        <div class="input-group">
          <ion-label class="input-label">Teléfono *</ion-label>
          <ion-input
            [(ngModel)]="nuevoCliente.telefono"
            type="tel"
            placeholder="Ingresa el teléfono"
            class="custom-input">
          </ion-input>
        </div>

        <!-- Botón guardar -->
        <ion-button
          expand="block"
          class="guardar-button"
          (click)="guardarNuevoCliente()"
          [disabled]="!nuevoCliente.nombre || !nuevoCliente.telefono || guardandoCliente">
          <ion-spinner *ngIf="guardandoCliente" name="crescent"></ion-spinner>
          <span *ngIf="!guardandoCliente">Guardar Cliente</span>
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
